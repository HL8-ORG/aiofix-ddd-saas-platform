# 07-部署与运维设计之1
## 1. 部署架构设计

### 1.1 整体部署架构

#### 架构设计原则

1. **高可用性**：通过多实例部署和负载均衡确保服务可用性
2. **可扩展性**：支持水平扩展和垂直扩展
3. **安全性**：多层安全防护，包括网络安全、应用安全、数据安全
4. **可维护性**：标准化的部署流程和运维工具
5. **成本效益**：合理利用云资源，优化成本结构

#### 部署环境划分

```mermaid
graph LR
    subgraph "开发环境"
        A1[开发服务器]
        A2[本地开发环境]
    end
    
    subgraph "测试环境"
        B1[测试服务器]
        B2[集成测试环境]
        B3[性能测试环境]
    end
    
    subgraph "预生产环境"
        C1[预生产服务器]
        C2[用户验收测试]
    end
    
    subgraph "生产环境"
        D1[生产服务器集群]
        D2[灾备环境]
    end
    
    A1 --> B1
    B1 --> C1
    C1 --> D1
    
    classDef dev fill:#e3f2fd,stroke:#1565c0,stroke-width:2px,color:#0d47a1
    classDef test fill:#f3e5f5,stroke:#6a1b9a,stroke-width:2px,color:#4a148c
    classDef staging fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px,color:#1b5e20
    classDef prod fill:#ffebee,stroke:#c62828,stroke-width:2px,color:#b71c1c
    
    class A1,A2 dev
    class B1,B2,B3 test
    class C1,C2 staging
    class D1,D2 prod
```

### 1.2 容器化方案

#### Docker容器设计

**应用容器配置**

```dockerfile
# Dockerfile
FROM node:18-alpine AS builder

# 设置工作目录
WORKDIR /app

# 复制package文件
COPY package*.json ./
COPY pnpm-lock.yaml ./

# 安装依赖
RUN npm install -g pnpm
RUN pnpm install --frozen-lockfile

# 复制源代码
COPY . .

# 构建应用
RUN pnpm run build

# 生产镜像
FROM node:18-alpine AS production

WORKDIR /app

# 安装生产依赖
COPY package*.json ./
COPY pnpm-lock.yaml ./
RUN npm install -g pnpm
RUN pnpm install --prod --frozen-lockfile

# 复制构建产物
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/node_modules ./node_modules

# 创建非root用户
RUN addgroup -g 1001 -S nodejs
RUN adduser -S nestjs -u 1001

# 设置权限
RUN chown -R nestjs:nodejs /app
USER nestjs

# 暴露端口
EXPOSE 3000

# 健康检查
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:3000/health || exit 1

# 启动命令
CMD ["node", "dist/main"]
```

**Docker Compose配置**

```yaml
# docker-compose.yml
version: '3.8'

services:
  # IAM API服务
  iam-api:
    build: .
    container_name: iam-api
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgresql://user:password@postgres:5432/iam_db
      - REDIS_URL=redis://redis:6379
    depends_on:
      - postgres
      - redis
    networks:
      - iam-network
    restart: unless-stopped
    deploy:
      replicas: 3
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  # PostgreSQL数据库
  postgres:
    image: postgres:15-alpine
    container_name: iam-postgres
    environment:
      POSTGRES_DB: iam_db
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-scripts:/docker-entrypoint-initdb.d
    ports:
      - "5432:5432"
    networks:
      - iam-network
    restart: unless-stopped

  # Redis缓存
  redis:
    image: redis:7-alpine
    container_name: iam-redis
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    networks:
      - iam-network
    restart: unless-stopped

  # NGINX负载均衡器
  nginx:
    image: nginx:alpine
    container_name: iam-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/ssl:/etc/nginx/ssl
    depends_on:
      - iam-api
    networks:
      - iam-network
    restart: unless-stopped

volumes:
  postgres_data:
  redis_data:

networks:
  iam-network:
    driver: bridge
```

### 1.3 环境管理策略

#### 环境配置管理

**环境变量配置**

```typescript
// config/environment.ts
export interface EnvironmentConfig {
  // 应用配置
  NODE_ENV: 'development' | 'staging' | 'production';
  PORT: number;
  API_VERSION: string;
  
  // 数据库配置
  DATABASE_URL: string;
  DATABASE_POOL_SIZE: number;
  
  // Redis配置
  REDIS_URL: string;
  REDIS_PASSWORD?: string;
  
  // JWT配置
  JWT_SECRET: string;
  JWT_EXPIRES_IN: string;
  
  // 日志配置
  LOG_LEVEL: string;
  LOG_FORMAT: 'json' | 'text';
  
  // 监控配置
  ENABLE_METRICS: boolean;
  METRICS_PORT: number;
}

export const getEnvironmentConfig = (): EnvironmentConfig => {
  return {
    NODE_ENV: (process.env.NODE_ENV as any) || 'development',
    PORT: parseInt(process.env.PORT || '3000', 10),
    API_VERSION: process.env.API_VERSION || 'v1',
    
    DATABASE_URL: process.env.DATABASE_URL || 'postgresql://localhost:5432/iam_db',
    DATABASE_POOL_SIZE: parseInt(process.env.DATABASE_POOL_SIZE || '10', 10),
    
    REDIS_URL: process.env.REDIS_URL || 'redis://localhost:6379',
    REDIS_PASSWORD: process.env.REDIS_PASSWORD,
    
    JWT_SECRET: process.env.JWT_SECRET || 'your-secret-key',
    JWT_EXPIRES_IN: process.env.JWT_EXPIRES_IN || '24h',
    
    LOG_LEVEL: process.env.LOG_LEVEL || 'info',
    LOG_FORMAT: (process.env.LOG_FORMAT as any) || 'json',
    
    ENABLE_METRICS: process.env.ENABLE_METRICS === 'true',
    METRICS_PORT: parseInt(process.env.METRICS_PORT || '9090', 10),
  };
};
```

**配置验证**

```typescript
// config/validation.ts
import { plainToClass } from 'class-transformer';
import { IsString, IsNumber, IsBoolean, validateSync } from 'class-validator';

class EnvironmentVariables {
  @IsString()
  NODE_ENV: string;

  @IsNumber()
  PORT: number;

  @IsString()
  DATABASE_URL: string;

  @IsString()
  REDIS_URL: string;

  @IsString()
  JWT_SECRET: string;

  @IsBoolean()
  ENABLE_METRICS: boolean;
}

export function validate(config: Record<string, unknown>) {
  const validatedConfig = plainToClass(EnvironmentVariables, config, {
    enableImplicitConversion: true,
  });
  
  const errors = validateSync(validatedConfig, {
    skipMissingProperties: false,
  });

  if (errors.length > 0) {
    throw new Error(errors.toString());
  }
  
  return validatedConfig;
}
```

### 1.4 配置管理方案

#### 配置分层管理

```mermaid
graph TD
    A[应用配置] --> B[环境配置]
    A --> C[功能配置]
    A --> D[安全配置]
    
    B --> E[开发环境]
    B --> F[测试环境]
    B --> G[生产环境]
    
    C --> H[数据库配置]
    C --> I[缓存配置]
    C --> J[日志配置]
    
    D --> K[JWT配置]
    D --> L[加密配置]
    D --> M[权限配置]
    
    classDef config fill:#e3f2fd,stroke:#1565c0,stroke-width:2px,color:#0d47a1
    classDef env fill:#f3e5f5,stroke:#6a1b9a,stroke-width:2px,color:#4a148c
    classDef feature fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px,color:#1b5e20
    classDef security fill:#ffebee,stroke:#c62828,stroke-width:2px,color:#b71c1c
    
    class A,B,C,D config
    class E,F,G env
    class H,I,J feature
    class K,L,M security
```

#### 配置热更新机制

```typescript
// config/config.service.ts
import { Injectable, OnModuleInit } from '@nestjs/common';
import { ConfigService } from '@nestjs/config';
import { EventEmitter2 } from '@nestjs/event-emitter';

@Injectable()
export class AppConfigService implements OnModuleInit {
  private configCache = new Map<string, any>();

  constructor(
    private configService: ConfigService,
    private eventEmitter: EventEmitter2,
  ) {}

  onModuleInit() {
    // 监听配置变更事件
    this.eventEmitter.on('config.changed', (key: string, value: any) => {
      this.configCache.set(key, value);
      this.eventEmitter.emit('app.config.updated', { key, value });
    });
  }

  get<T>(key: string, defaultValue?: T): T {
    // 优先从缓存获取
    if (this.configCache.has(key)) {
      return this.configCache.get(key);
    }
    
    const value = this.configService.get<T>(key, defaultValue);
    this.configCache.set(key, value);
    return value;
  }

  set(key: string, value: any): void {
    this.configCache.set(key, value);
    this.eventEmitter.emit('config.changed', key, value);
  }

  // 获取数据库配置
  getDatabaseConfig() {
    return {
      url: this.get<string>('DATABASE_URL'),
      poolSize: this.get<number>('DATABASE_POOL_SIZE', 10),
      ssl: this.get<boolean>('DATABASE_SSL', false),
    };
  }

  // 获取Redis配置
  getRedisConfig() {
    return {
      url: this.get<string>('REDIS_URL'),
      password: this.get<string>('REDIS_PASSWORD'),
      db: this.get<number>('REDIS_DB', 0),
    };
  }

  // 获取JWT配置
  getJwtConfig() {
    return {
      secret: this.get<string>('JWT_SECRET'),
      expiresIn: this.get<string>('JWT_EXPIRES_IN', '24h'),
      refreshExpiresIn: this.get<string>('JWT_REFRESH_EXPIRES_IN', '7d'),
    };
  }
}
```
